# ğŸ©º EHR å¤šè¡¨æ‹¼æ¥ â†’ å•æ‚£è€… JSON æ„å»ºå·¥å…·

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

è¿™ä¸ªé¡¹ç›®å®ç°äº†ä¸€ä¸ªé«˜æ•ˆçš„æ•°æ®ç®¡é“ï¼Œç”¨äºå°†ç”µå­ç—…å†ï¼ˆEHRï¼‰ç³»ç»Ÿä¸­çš„å¤šä¸ª CSV è¡¨æ ¼æ•°æ®æ•´åˆæˆç»“æ„åŒ–çš„å•æ‚£è€… JSON æ–‡ä»¶ï¼Œä¸“é—¨ç”¨äº**ä¸´åºŠæ‘˜è¦ç”Ÿæˆ**å’Œ**å¹»è§‰æ£€æµ‹**æ¨¡å‹è®­ç»ƒã€‚

## ğŸ¯ ä¸»è¦åŠŸèƒ½

âœ… **å¤šè¡¨æ•°æ®æ•´åˆ**: è‡ªåŠ¨è¯»å–å’Œå¤„ç† 6 ä¸ª EHR æ•°æ®è¡¨  
âœ… **æ‚£è€…ä¸ºä¸­å¿ƒ**: æŒ‰ `subject_id` èšåˆæ¯ä¸ªæ‚£è€…çš„å®Œæ•´åŒ»ç–—è®°å½•  
âœ… **ç»“æ„åŒ–è¾“å‡º**: ç”Ÿæˆæ ‡å‡†åŒ–çš„ JSON æ ¼å¼ï¼ŒåŒ…å«å…ƒæ•°æ®å’Œæ‚£è€…æ•°æ®  
âœ… **å†…å­˜ä¼˜åŒ–**: æ”¯æŒå¤§æ•°æ®æ–‡ä»¶çš„åˆ†å—å¤„ç†ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º  
âœ… **æ•°æ®éªŒè¯**: å†…ç½®æ•°æ®è´¨é‡æ£€æŸ¥å’Œè¦†ç›–ç‡åˆ†æ  
âœ… **åŒæ ¼å¼è¾“å‡º**: åŒæ—¶ç”Ÿæˆ `.json` å’Œ `.jsonl` æ ¼å¼æ–‡ä»¶  

## ğŸ“ è¾“å…¥æ•°æ®ç»“æ„

é¡¹ç›®å¤„ç†ä»¥ä¸‹ 6 ä¸ª CSV æ•°æ®è¡¨ï¼š

### 1. `diagnosis.csv` - è¯Šæ–­ä¿¡æ¯
```csv
subject_id,stay_id,seq_num,icd_code,icd_version,icd_title
10000032,38112554,1,78959,9,OTHER ASCITES
```

### 2. `discharge.csv` - å‡ºé™¢è®°å½•ï¼ˆå®é™…ä¸ºå‡ºé™¢æŠ¥å‘Šæ–‡æœ¬ï¼‰
```csv
note_id,subject_id,hadm_id,note_type,note_seq,charttime,storetime,text
10000032-DS-22,10000032,22841357,DS,22,2180-06-27 00:00:00,2180-07-01 10:15:00,"è¯¦ç»†å‡ºé™¢æŠ¥å‘Š..."
```

### 3. `discharge_target.csv` - å‡ºé™¢é¢„æµ‹ç›®æ ‡ï¼ˆå®é™…ä¸ºå‡ºé™¢æŒ‡å¯¼ï¼‰
```csv
note_id,hadm_id,discharge_instructions,brief_hospital_course,discharge_instructions_word_count,brief_hospital_course_word_count
15373895-DS-19,28448473,"å‡ºé™¢æŒ‡å¯¼å†…å®¹...","ä½é™¢è¿‡ç¨‹æ‘˜è¦...",760,398
```

### 4. `edstays.csv` - æ€¥è¯Šç•™è§‚è®°å½•
```csv
subject_id,hadm_id,stay_id,intime,outtime,gender,race,arrival_transport,disposition
10000032,22841357,38112554,2180-06-26 15:54:00,2180-06-26 21:31:00,F,WHITE,AMBULANCE,ADMITTED
```

### 5. `radiology.csv` - æ”¾å°„å½±åƒæŠ¥å‘Š
```csv
note_id,subject_id,hadm_id,note_type,note_seq,charttime,storetime,text
10000032-RR-22,10000032,22841357,RR,22,2180-06-26 17:15:00,2180-06-26 19:28:00,"å½±åƒæ£€æŸ¥æŠ¥å‘Š..."
```

### 6. `triage.csv` - åˆ†è¯Šä¿¡æ¯
```csv
subject_id,stay_id,temperature,heartrate,resprate,o2sat,sbp,dbp,pain,acuity,chiefcomplaint
10000032,38112554,98.9,88.0,18.0,97.0,116.0,88.0,10,3.0,Abdominal distention
```

## ğŸ”§ å®‰è£…å’Œä½¿ç”¨

### ç¯å¢ƒè¦æ±‚
- Python 3.8+
- pandas >= 1.5.0
- numpy >= 1.21.0

### å®‰è£…ä¾èµ–
```bash
pip install -r requirements_ehr.txt
```

### å¿«é€Ÿå¼€å§‹

#### 1. ä½¿ç”¨ç¤ºä¾‹è„šæœ¬ï¼ˆæ¨èï¼‰
```bash
python run_ehr_processor.py
```

#### 2. å‘½ä»¤è¡Œä½¿ç”¨
```bash
python ehr_data_processor.py --data_dir /path/to/csv/files --output_dir ./output
```

#### 3. è‡ªå®šä¹‰å‚æ•°
```bash
python ehr_data_processor.py \
    --data_dir /home/work/hd/discharge-me/train \
    --output_dir ./custom_output \
    --chunksize 20000
```

### å‚æ•°è¯´æ˜
- `--data_dir`: CSV æ•°æ®æ–‡ä»¶æ‰€åœ¨ç›®å½•
- `--output_dir`: è¾“å‡ºæ–‡ä»¶ä¿å­˜ç›®å½•ï¼ˆé»˜è®¤ï¼š`./output`ï¼‰
- `--chunksize`: åˆ†å—è¯»å–å¤§å°ï¼ˆé»˜è®¤ï¼š10000ï¼Œè®¾ä¸º 0 è¡¨ç¤ºä¸€æ¬¡æ€§è¯»å–ï¼‰

## ğŸ“„ è¾“å‡ºæ–‡ä»¶

### 1. `ehr_dataset_full.json` - å®Œæ•´æ•°æ®é›†
åŒ…å«å®Œæ•´çš„å…ƒæ•°æ®å’Œæ‰€æœ‰æ‚£è€…è®°å½•çš„ç»“æ„åŒ– JSON æ–‡ä»¶ï¼š

```json
{
  "description": {
    "dataset_name": "EHR Dataset Field Map",
    "purpose": "Provide structured per-patient data for clinical summarization and hallucination detection tasks.",
    "structure": "Each record contains universal keys shared across all files and unique fields from six EHR data sources.",
    "generated_at": "2025-10-18 19:59:46",
    "version": "1.0"
  },
  "inverse_map": {
    "subject_id": ["diagnosis", "discharge", "edstays", "radiology", "triage"],
    "hadm_id": ["discharge", "discharge_target", "edstays", "radiology"],
    ...
  },
  "metadata": {
    "subject_id": "identifier",
    "hadm_id": "identifier",
    "temperature": "vital_sign",
    "text": "clinical_text",
    ...
  },
  "patients": [
    {
      "name": "Patient 1",
      "universal": {
        "subject_id": 10000032,
        "hadm_id": 22841357,
        "stay_id": 38112554,
        "note_id": "10000032-DS-22",
        "note_type": "DS",
        "charttime": "2180-06-27 00:00:00",
        "storetime": "2180-07-01 10:15:00"
      },
      "diagnosis": {
        "seq_num": 1,
        "icd_code": "78959",
        "icd_version": 9,
        "icd_title": "OTHER ASCITES"
      },
      "discharge": {
        "note_type": "DS",
        "note_seq": 22,
        "text": "å®Œæ•´çš„å‡ºé™¢è®°å½•æ–‡æœ¬..."
      },
      "edstays": {
        "intime": "2180-06-26 15:54:00",
        "outtime": "2180-06-26 21:31:00",
        "gender": "F",
        "race": "WHITE",
        "arrival_transport": "AMBULANCE",
        "disposition": "ADMITTED"
      },
      "radiology": {
        "text": "å½±åƒæ£€æŸ¥æŠ¥å‘Šæ–‡æœ¬..."
      },
      "triage": {
        "temperature": 98.9,
        "heartrate": 88.0,
        "resprate": 18.0,
        "o2sat": 97.0,
        "sbp": 116.0,
        "dbp": 88.0,
        "pain": 10,
        "acuity": 3.0,
        "chiefcomplaint": "Abdominal distention"
      }
    }
  ]
}
```

### 2. `ehr_patients.jsonl` - æµå¼æ ¼å¼
æ¯è¡Œä¸€ä¸ªæ‚£è€… JSON å¯¹è±¡ï¼Œé€‚åˆæµå¼å¤„ç†å’Œæ¨¡å‹è®­ç»ƒï¼š

```jsonl
{"name": "Patient 1", "universal": {...}, "diagnosis": {...}, ...}
{"name": "Patient 2", "universal": {...}, "diagnosis": {...}, ...}
{"name": "Patient 3", "universal": {...}, "diagnosis": {...}, ...}
```

### 3. `processing_report.txt` - å¤„ç†æŠ¥å‘Š
è¯¦ç»†çš„æ•°æ®å¤„ç†ç»Ÿè®¡ä¿¡æ¯ï¼š

```
EHR æ•°æ®å¤„ç†æŠ¥å‘Š
==================================================

å¤„ç†æ—¶é—´: 2025-10-18 20:00:08
æ‚£è€…æ€»æ•°: 46998

å„è¡¨æ•°æ®è¦†ç›–æƒ…å†µ:
------------------------------
diagnosis: 46998/46998 (100.0%)
discharge: 46998/46998 (100.0%)
edstays: 46998/46998 (100.0%)
radiology: 46998/46998 (100.0%)
triage: 46998/46998 (100.0%)
```

### 4. `patient_summary_stats.csv` - æ‚£è€…ç»Ÿè®¡æ‘˜è¦
å¯ç”¨äºå¿«é€Ÿåˆ†æçš„ CSV æ ¼å¼ç»Ÿè®¡æ–‡ä»¶ï¼ŒåŒ…å«æ¯ä¸ªæ‚£è€…çš„åŸºæœ¬ä¿¡æ¯å’Œæ•°æ®å®Œæ•´æ€§æŒ‡æ ‡ã€‚

## ğŸ” æ•°æ®éªŒè¯

ä½¿ç”¨å†…ç½®çš„éªŒè¯å·¥å…·æ£€æŸ¥æ•°æ®è´¨é‡ï¼š

```bash
python validate_ehr_data.py
```

éªŒè¯åŠŸèƒ½åŒ…æ‹¬ï¼š
- âœ… JSON æ ¼å¼éªŒè¯
- âœ… æ•°æ®ç»“æ„å®Œæ•´æ€§æ£€æŸ¥
- âœ… å­—æ®µè¦†ç›–ç‡åˆ†æ
- âœ… æ•°æ®è´¨é‡é—®é¢˜æ£€æµ‹
- âœ… æ ·æœ¬æ‚£è€…å±•ç¤º

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ç‰¹æ€§

### å†…å­˜ç®¡ç†
- **åˆ†å—è¯»å–**: æ”¯æŒå¤§æ–‡ä»¶çš„åˆ†å—å¤„ç†ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º
- **ç´¢å¼•ä¼˜åŒ–**: é¢„æ„å»ºæ‚£è€…ç´¢å¼•ï¼Œå®ç° O(1) æŸ¥æ‰¾æ•ˆç‡
- **å¢é‡å¤„ç†**: é€æ‚£è€…æ„å»º JSONï¼Œé™ä½å†…å­˜å³°å€¼

### å¤„ç†æ•ˆç‡
- **å¹¶è¡Œå‹å¥½**: æ¶æ„æ”¯æŒæœªæ¥çš„å¤šè¿›ç¨‹å¹¶è¡ŒåŒ–
- **ç¼“å­˜æœºåˆ¶**: æ™ºèƒ½çš„æ•°æ®ç¼“å­˜å‡å°‘é‡å¤è®¡ç®—
- **æµå¼è¾“å‡º**: æ”¯æŒå¤§è§„æ¨¡æ•°æ®çš„æµå¼å¤„ç†

### æ‰©å±•æ€§
- **æ¨¡å—åŒ–è®¾è®¡**: æ¸…æ™°çš„ç±»ç»“æ„ä¾¿äºåŠŸèƒ½æ‰©å±•
- **é…ç½®åŒ–**: è¡¨ç»“æ„å’Œå­—æ®µæ˜ å°„å®Œå…¨å¯é…ç½®
- **å¤šæ ¼å¼æ”¯æŒ**: å¯è½»æ¾æ‰©å±•æ”¯æŒå…¶ä»–è¾“å‡ºæ ¼å¼

## ğŸ“Š æ•°æ®ç»Ÿè®¡ï¼ˆç¤ºä¾‹è¿è¡Œç»“æœï¼‰

åŸºäº discharge-me è®­ç»ƒæ•°æ®é›†çš„å¤„ç†ç»“æœï¼š

- **æ€»æ‚£è€…æ•°**: 46,998 äºº
- **æ•°æ®æ–‡ä»¶**: 6 ä¸ªï¼ˆæ€»è®¡ ~1.4 GBï¼‰
- **å¤„ç†æ—¶é—´**: ~2 åˆ†é’Ÿ
- **è¾“å‡ºå¤§å°**: 
  - `ehr_dataset_full.json`: 646.3 MB
  - `ehr_patients.jsonl`: 628.6 MB
- **æ•°æ®è¦†ç›–ç‡**: 
  - diagnosis: 100%
  - discharge: 100%
  - edstays: 100%
  - radiology: 100%
  - triage: 100%
  - discharge_target: 0% (è¡¨ç»“æ„ä¸åŒ¹é…)

## ğŸ› ï¸ æ ¸å¿ƒæŠ€æœ¯æ¶æ„

### æ•°æ®å¤„ç†æµç¨‹
```
1. æ–‡ä»¶è¯»å– â†’ 2. æ•°æ®æ¸…æ´— â†’ 3. æ‚£è€…ç´¢å¼•æ„å»º â†’ 4. JSON æ‹¼è£… â†’ 5. è¾“å‡ºç”Ÿæˆ
```

### å…³é”®ç®—æ³•
1. **"å…ˆåˆ†è¡¨èšåˆ â†’ å†æŒ‰ ID æ‹¼è£…"** çš„è®¾è®¡ç†å¿µ
2. **åŸºäº subject_id çš„ groupby èšåˆ**ï¼Œé¿å…å¤æ‚çš„å¤šè¡¨ join
3. **O(1) ç´¢å¼•æŸ¥æ‰¾**ï¼Œæé«˜æ‚£è€…æ•°æ®æ£€ç´¢æ•ˆç‡
4. **å¢é‡ JSON æ„å»º**ï¼Œé€æ‚£è€…å¤„ç†é™ä½å†…å­˜ä½¿ç”¨

### ä»£ç ç»“æ„
```
EHRDataProcessor/
â”œâ”€â”€ __init__()              # åˆå§‹åŒ–é…ç½®
â”œâ”€â”€ read_csv_file()         # æ–‡ä»¶è¯»å–
â”œâ”€â”€ load_all_data()         # æ‰¹é‡æ•°æ®åŠ è½½
â”œâ”€â”€ clean_dataframe()       # æ•°æ®æ¸…æ´—
â”œâ”€â”€ build_patient_index()   # ç´¢å¼•æ„å»º
â”œâ”€â”€ build_patient_json()    # å•æ‚£è€… JSON æ„å»º
â”œâ”€â”€ generate_metadata()     # å…ƒæ•°æ®ç”Ÿæˆ
â”œâ”€â”€ process_data()          # ä¸»å¤„ç†æµç¨‹
â””â”€â”€ save_results()          # ç»“æœä¿å­˜
```

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### æ¨¡å‹è®­ç»ƒåœºæ™¯
1. **ä¸´åºŠæ‘˜è¦ç”Ÿæˆ**: ä½¿ç”¨ `ehr_patients.jsonl` è¿›è¡Œæµå¼è®­ç»ƒ
2. **å¹»è§‰æ£€æµ‹**: åˆ©ç”¨ç»“æ„åŒ–çš„ `universal` å­—æ®µè¿›è¡Œäº‹å®éªŒè¯
3. **å¤šæ¨¡æ€å­¦ä¹ **: ç»“åˆæ–‡æœ¬ï¼ˆ`text` å­—æ®µï¼‰å’Œç»“æ„åŒ–æ•°æ®ï¼ˆç”Ÿå‘½ä½“å¾ç­‰ï¼‰

### æ•°æ®åˆ†æåœºæ™¯
1. **ç»Ÿè®¡åˆ†æ**: ä½¿ç”¨ `patient_summary_stats.csv` è¿›è¡Œå¿«é€Ÿåˆ†æ
2. **æ•°æ®æ¢ç´¢**: ä½¿ç”¨å®Œæ•´çš„ JSON æ–‡ä»¶è¿›è¡Œæ·±åº¦æŒ–æ˜
3. **è´¨é‡ç›‘æ§**: å®šæœŸè¿è¡ŒéªŒè¯å·¥å…·ç¡®ä¿æ•°æ®è´¨é‡

### ç”Ÿäº§éƒ¨ç½²
1. **æ‰¹å¤„ç†**: é€‚åˆå¤§è§„æ¨¡ç¦»çº¿æ•°æ®å¤„ç†
2. **å¢é‡æ›´æ–°**: æ”¯æŒæ–°æ•°æ®çš„å¢é‡å¤„ç†
3. **ç›‘æ§å‘Šè­¦**: é›†æˆå¤„ç†æŠ¥å‘Šè¿›è¡ŒçŠ¶æ€ç›‘æ§

## ğŸ”§ è‡ªå®šä¹‰æ‰©å±•

### æ·»åŠ æ–°çš„æ•°æ®è¡¨
1. åœ¨ `file_config` ä¸­æ·»åŠ æ–°è¡¨é…ç½®
2. å®šä¹‰ `key_fields` å’Œ `unique_fields`
3. æ›´æ–° `universal_fields` é›†åˆï¼ˆå¦‚éœ€è¦ï¼‰

### è‡ªå®šä¹‰å­—æ®µæ˜ å°„
1. ä¿®æ”¹ `metadata` å­—å…¸æ·»åŠ æ–°å­—æ®µç±»å‹
2. åœ¨ `clean_dataframe()` ä¸­æ·»åŠ ç‰¹å®šçš„æ•°æ®å¤„ç†é€»è¾‘
3. æ›´æ–° `extract_table_specific_fields()` æ–¹æ³•

### è¾“å‡ºæ ¼å¼æ‰©å±•
1. åœ¨ `save_results()` ä¸­æ·»åŠ æ–°çš„å¯¼å‡ºé€»è¾‘
2. æ”¯æŒ Parquetã€Avro ç­‰å…¶ä»–æ ¼å¼
3. é›†æˆäº‘å­˜å‚¨ API è¿›è¡Œç›´æ¥ä¸Šä¼ 

## ğŸ“ æ”¯æŒå’Œç»´æŠ¤

### å¸¸è§é—®é¢˜
1. **å†…å­˜ä¸è¶³**: å‡å° `chunksize` å‚æ•°
2. **å¤„ç†æ—¶é—´é•¿**: å¢å¤§ `chunksize` æˆ–ä½¿ç”¨ SSD å­˜å‚¨
3. **æ•°æ®ç¼ºå¤±**: æ£€æŸ¥åŸå§‹ CSV æ–‡ä»¶çš„å­—æ®µåå’Œæ ¼å¼

### æ—¥å¿—å’Œè°ƒè¯•
- æ‰€æœ‰å¤„ç†æ­¥éª¤éƒ½æœ‰è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
- ä½¿ç”¨ `logging` æ¨¡å—å¯è°ƒæ•´æ—¥å¿—çº§åˆ«
- å¼‚å¸¸å¤„ç†ç¡®ä¿é”™è¯¯ä¿¡æ¯çš„å®Œæ•´æ€§

### ç‰ˆæœ¬å†å²
- **v1.0** (2025-10-18): åˆå§‹ç‰ˆæœ¬ï¼Œæ”¯æŒ 6 è¡¨æ‹¼æ¥å’ŒåŒæ ¼å¼è¾“å‡º

---

## ğŸ‰ æ€»ç»“

è¿™ä¸ª EHR æ•°æ®å¤„ç†å·¥å…·å®ç°äº†é«˜æ•ˆã€å¯æ‰©å±•çš„å¤šè¡¨æ•°æ®æ•´åˆæ–¹æ¡ˆï¼Œå®Œç¾æ»¡è¶³äº†ä¸´åºŠ AI æ¨¡å‹è®­ç»ƒçš„æ•°æ®éœ€æ±‚ã€‚é€šè¿‡ç»“æ„åŒ–çš„ JSON è¾“å‡ºå’Œå®Œå–„çš„å…ƒæ•°æ®æ”¯æŒï¼Œä¸ºåç»­çš„æ¨¡å‹å¼€å‘æä¾›äº†åšå®çš„æ•°æ®åŸºç¡€ã€‚

**ç«‹å³å¼€å§‹ä½¿ç”¨**ï¼š
```bash
python run_ehr_processor.py
```