# MS-SWIFT 环境修复和使用指南

## 🔧 环境问题修复

### 1. 修复 bitsandbytes 问题

根据您遇到的错误，主要是 `bitsandbytes` 和 `triton` 依赖问题。以下是解决方案：

```bash
# 方案1: 重新安装 bitsandbytes
pip uninstall bitsandbytes -y
pip install bitsandbytes

# 方案2: 设置环境变量禁用量化
export USE_BNB=0
export BNB_CUDA_VERSION=""

# 方案3: 安装兼容版本
pip install bitsandbytes==0.43.0
pip install triton>=2.0.0
```

### 2. 创建环境配置脚本

创建 `setup_env.sh`:

```bash
#!/bin/bash
# 环境配置脚本

echo "配置 MS-SWIFT 环境..."

# 禁用有问题的量化库
export USE_BNB=0
export BNB_CUDA_VERSION=""
export CUDA_VISIBLE_DEVICES=0

# 设置 Python 路径
export PYTHONPATH=$PYTHONPATH:/home/work/hd

echo "环境配置完成！"
echo "USE_BNB=$USE_BNB"
echo "CUDA_VISIBLE_DEVICES=$CUDA_VISIBLE_DEVICES"
```

## 🚀 推荐使用方法

### 方法1: 命令行推理（推荐）

```bash
# 设置环境
source setup_env.sh

# 推理小模型
CUDA_VISIBLE_DEVICES=0 swift infer \
    --model ./models/Qwen3-4B-Thinking-2507-FP8 \
    --stream true \
    --infer_backend pt \
    --max_new_tokens 256 \
    --temperature 0.7

# 如果上面失败，尝试不使用流式输出
CUDA_VISIBLE_DEVICES=0 swift infer \
    --model ./models/Qwen3-4B-Thinking-2507-FP8 \
    --infer_backend pt \
    --max_new_tokens 256
```

### 方法2: Web UI 界面（最简单）

```bash
# 启动中文 Web 界面
SWIFT_UI_LANG=zh swift web-ui

# 或启动英文界面
SWIFT_UI_LANG=en swift web-ui
```

然后在浏览器打开 `http://localhost:7860`

### 方法3: 使用 transformers 替代

如果 MS-SWIFT 有问题，可以使用原生 transformers：

```python
from transformers import AutoModelForCausalLM, AutoTokenizer
import torch

# 加载本地模型
model_path = "./models/Qwen3-4B-Thinking-2507-FP8"
tokenizer = AutoTokenizer.from_pretrained(model_path, trust_remote_code=True)
model = AutoModelForCausalLM.from_pretrained(
    model_path,
    torch_dtype=torch.float16,
    device_map="auto",
    trust_remote_code=True
)

# 简单对话
def chat(question):
    messages = [{"role": "user", "content": question}]
    text = tokenizer.apply_chat_template(messages, tokenize=False, add_generation_prompt=True)
    inputs = tokenizer([text], return_tensors="pt").to(model.device)
    
    with torch.no_grad():
        outputs = model.generate(**inputs, max_new_tokens=256, temperature=0.7)
    
    response = tokenizer.decode(outputs[0][len(inputs.input_ids[0]):], skip_special_tokens=True)
    return response

# 测试
print(chat("你好，请介绍一下自己"))
```

## 🛠️ 故障排除

### 问题1: ImportError 或 ModuleNotFoundError

```bash
# 重新安装 ms-swift
pip uninstall ms-swift -y
pip install ms-swift -U

# 安装完整依赖
pip install torch transformers accelerate
```

### 问题2: CUDA 相关错误

```bash
# 检查 CUDA 状态
nvidia-smi

# 重新安装 PyTorch
pip uninstall torch torchvision torchaudio -y
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
```

### 问题3: 显存不足

```bash
# 使用量化（如果 bitsandbytes 工作）
--load_in_8bit true

# 或减少批处理大小
--per_device_train_batch_size 1
--max_length 1024
```

## 📋 快速测试命令

创建测试脚本 `quick_test.py`:

```python
#!/usr/bin/env python3
import os
os.environ['USE_BNB'] = '0'  # 禁用有问题的量化

try:
    # 测试 swift 导入
    from swift.llm import get_model_list
    print("✅ MS-SWIFT 导入成功")
    
    # 显示支持的模型
    models = get_model_list()
    print(f"支持的模型数量: {len(models)}")
    
except Exception as e:
    print(f"❌ MS-SWIFT 导入失败: {e}")
    
try:
    # 测试 transformers
    from transformers import AutoTokenizer
    print("✅ Transformers 可用")
    
except Exception as e:
    print(f"❌ Transformers 不可用: {e}")

# 检查本地模型
models = [
    "./models/Qwen3-4B-Thinking-2507-FP8",
    "./models/Qwen3-30B-A3B-Thinking-2507"
]

for model_path in models:
    if os.path.exists(model_path):
        print(f"✅ 模型存在: {model_path}")
        # 检查关键文件
        config_file = os.path.join(model_path, "config.json")
        if os.path.exists(config_file):
            print(f"  ✅ config.json")
        else:
            print(f"  ❌ config.json 缺失")
    else:
        print(f"❌ 模型不存在: {model_path}")
```

## 🎯 推荐工作流程

1. **环境准备**
   ```bash
   # 设置环境变量
   export USE_BNB=0
   export BNB_CUDA_VERSION=""
   
   # 测试环境
   python quick_test.py
   ```

2. **选择使用方式**
   - 新手：使用 Web UI (`swift web-ui`)
   - 命令行：使用 `swift infer`
   - 编程：使用 transformers 库

3. **从小模型开始**
   - 先测试 4B 模型
   - 成功后再尝试 30B 模型

4. **逐步增加复杂度**
   - 推理 → 微调 → 部署

## 📞 获取帮助

- 查看详细文档：`MS-SWIFT_使用指南.md`
- 运行测试脚本：`python test_swift_fixed.py`
- GitHub Issues: https://github.com/modelscope/ms-swift/issues
- 官方文档: https://swift.readthedocs.io/zh-cn/latest/